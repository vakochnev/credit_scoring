# Deploy workflow Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° PythonAnywhere
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ push Ð² main Ð²ÐµÑ‚ÐºÑƒ Ð¸Ð»Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· workflow_dispatch
# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ (Ñ‚ÐµÑÑ‚Ñ‹, Ð»Ð¸Ð½Ñ‚ÐµÑ€Ñ‹, Docker) Ð¿ÐµÑ€ÐµÐ´ Ð´ÐµÐ¿Ð»Ð¾ÐµÐ¼

name: Deploy to PythonAnywhere

# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑÐºÐ°
on:
  push:
    branches: [ main ]  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ push Ð² main
  workflow_dispatch:  # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· GitHub UI

jobs:
  # Job 1: ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ´ Ð´ÐµÐ¿Ð»Ð¾ÐµÐ¼
  # Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾, Ð¸Ð½Ð°Ñ‡Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ
  pre-deploy:
    name: Pre-Deploy Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pylint pytest pytest-cov pytest-asyncio
        pip install -r requirements.txt
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð´Ð° (ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ - Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ)
    - name: Run Black (format check)
      run: |
        black --check --diff . || (echo "âŒ Code formatting check failed. Run 'black .' to fix." && exit 1)
    
    # Ð›Ð¸Ð½Ñ‚Ð¸Ð½Ð³ ÐºÐ¾Ð´Ð° (ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ - Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ)
    - name: Run Flake8 (linting)
      run: |
        # ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ - Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || exit 1
        # Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    # Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· (Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾)
    - name: Run Pylint
      run: |
        pylint app/ shared/ frontend/ --disable=C0111 --disable=R0903 || true
    
    # Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² (ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ - Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ Ð¿Ð°Ð´ÐµÐ½Ð¸Ð¸ Ñ‚ÐµÑÑ‚Ð¾Ð²)
    - name: Run tests
      run: |
        pytest tests/ -v --cov=app --cov=shared --cov-report=xml --cov-report=term-missing || exit 1
    
    - name: Check imports
      run: |
        python -c "import app.main; import shared.config; import shared.auth; import shared.models; print('âœ… All imports successful')"
    
    - name: Check Alembic migrations
      run: |
        alembic check || echo "âš ï¸ Migration check skipped"
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Backend Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.backend
        push: false
        tags: credit-scoring-backend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build Frontend Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.frontend
        push: false
        tags: credit-scoring-frontend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Verify Docker images
      run: |
        docker images | grep credit-scoring-backend
        docker images | grep credit-scoring-frontend
        echo "âœ… Docker images built successfully"

  # Job 2: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° PythonAnywhere
  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ pre-deploy
  deploy:
    name: Deploy to PythonAnywhere
    runs-on: ubuntu-latest
    needs: pre-deploy  # Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ: Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ pre-deploy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº PythonAnywhere
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        # ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ SSH ÐºÐ»ÑŽÑ‡ Ð¸Ð· GitHub Secrets
        ssh-private-key: ${{ secrets.PYTHONANYWHERE_SSH_KEY }}
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ…Ð¾ÑÑ‚Ð° PythonAnywhere Ð² known_hosts Ð´Ð»Ñ Ð¸Ð·Ð±ÐµÐ¶Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´Ð»Ð¸Ð½Ð½Ð¾ÑÑ‚Ð¸
    - name: Add PythonAnywhere to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.PYTHONANYWHERE_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to PythonAnywhere
      env:
        PYTHONANYWHERE_USER: ${{ secrets.PYTHONANYWHERE_USER }}
        PYTHONANYWHERE_HOST: ${{ secrets.PYTHONANYWHERE_HOST }}
        PYTHONANYWHERE_PATH: ${{ secrets.PYTHONANYWHERE_PATH }}
      run: |
        echo "ðŸš€ Starting deployment to PythonAnywhere..."
        echo "ðŸ“‹ Deployment info:"
        echo "  User: ${PYTHONANYWHERE_USER}"
        echo "  Host: ${PYTHONANYWHERE_HOST}"
        echo "  Path: ${PYTHONANYWHERE_PATH}"
        
        # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´ÐµÐ¿Ð»Ð¾Ñ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ
        
        # Ð¨Ð°Ð³ 1: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð¸Ð· git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        echo "ðŸ“¦ Updating code from repository..."
        cd $PYTHONANYWHERE_PATH
        git fetch origin  # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð¸Ð· ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        git reset --hard origin/main  # Ð¡Ð±Ñ€Ð¾Ñ Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÑŽ main Ð²ÐµÑ‚ÐºÐ¸
        echo "âœ… Code updated"
        
        # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        echo "ðŸ“¥ Installing/updating dependencies..."
        source venv/bin/activate  # ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
        pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed"
        
        # Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        echo "ðŸ—„ï¸ Applying database migrations..."
        alembic upgrade head || echo "âš ï¸ Migration error (may be expected)"
        echo "âœ… Migrations applied"
        
        # Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ
        echo "ðŸ‘¤ Creating/updating users..."
        python scripts/create_users.py || echo "âš ï¸ User creation error (may be expected)"
        echo "âœ… Users updated"
        
        # Ð¨Ð°Ð³ 5: ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· touch WSGI Ñ„Ð°Ð¹Ð»Ð°
        echo "ðŸ”„ Reloading web application..."
        touch /var/www/${PYTHONANYWHERE_USER}_pythonanywhere_com_wsgi.py
        echo "âœ… Application reloaded"
        
        echo "âœ… Deployment completed successfully!"
        EOF
        
        # ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
        scp deploy.sh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST}:~/deploy.sh
        
        # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} "chmod +x ~/deploy.sh && ~/deploy.sh"
        
        # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
        rm deploy.sh
    
    - name: Verify deployment
      env:
        PYTHONANYWHERE_USER: ${{ secrets.PYTHONANYWHERE_USER }}
        PYTHONANYWHERE_HOST: ${{ secrets.PYTHONANYWHERE_HOST }}
        PYTHONANYWHERE_PATH: ${{ secrets.PYTHONANYWHERE_PATH }}
      run: |
        echo "ðŸ” Verifying deployment..."
        ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} << 'VERIFY'
          cd ${PYTHONANYWHERE_PATH}
          source venv/bin/activate
          python -c "import app.main; print('âœ… Application imports successfully')" || exit 1
          echo "âœ… Deployment verified"
        VERIFY
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Application available at: https://${PYTHONANYWHERE_USER}.pythonanywhere.com"
        else
          echo "âŒ Deployment failed!"
          echo "ðŸ“‹ Check logs for details"
        fi

