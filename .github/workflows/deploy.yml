name: Deploy to PythonAnywhere

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to PythonAnywhere
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.PYTHONANYWHERE_SSH_KEY }}
    
    - name: Add PythonAnywhere to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.PYTHONANYWHERE_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to PythonAnywhere
      env:
        PYTHONANYWHERE_USER: ${{ secrets.PYTHONANYWHERE_USER }}
        PYTHONANYWHERE_HOST: ${{ secrets.PYTHONANYWHERE_HOST }}
        PYTHONANYWHERE_PATH: ${{ secrets.PYTHONANYWHERE_PATH }}
      run: |
        echo "ðŸš€ Starting deployment to PythonAnywhere..."
        
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸ“¦ Updating code from repository..."
        cd $PYTHONANYWHERE_PATH
        git fetch origin
        git reset --hard origin/main
        
        echo "ðŸ“¥ Installing/updating dependencies..."
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        
        echo "ðŸ—„ï¸ Applying database migrations..."
        alembic upgrade head || echo "âš ï¸ Migration error (may be expected)"
        
        echo "ðŸ‘¤ Creating/updating users..."
        python scripts/create_users.py || echo "âš ï¸ User creation error (may be expected)"
        
        echo "ðŸ”„ Reloading web application..."
        touch /var/www/${PYTHONANYWHERE_USER}_pythonanywhere_com_wsgi.py
        
        echo "âœ… Deployment completed successfully!"
        EOF
        
        # Copy deployment script to server
        scp deploy.sh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST}:~/deploy.sh
        
        # Execute deployment script
        ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} "chmod +x ~/deploy.sh && ~/deploy.sh"
        
        # Cleanup
        rm deploy.sh
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi

