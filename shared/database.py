# shared/database.py
"""
–ú–æ–¥—É–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è FastAPI

–ú–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SQLite-–±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQLAlchemy.
–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ñ–∏–¥–±—ç–∫–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- engine: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- SessionLocal: —Ñ–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π
- Base: –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è ORM-–º–æ–¥–µ–ª–µ–π

–ê–≤—Ç–æ—Ä: [–ö–æ—á–Ω–µ–≤–∞ –ê—Ä–∏–Ω–∞]
–ì–æ–¥: 2025
"""

from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker


# --- üóÑÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö ---
"""
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç–∏.
–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ./users.db (–≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞)

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
    - connect_args={"check_same_thread": False} ‚Äî –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è SQLite –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –≤ FastAPI
    - –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PostgreSQL –∏–ª–∏ MySQL
"""
SQLALCHEMY_DATABASE_URL = "sqlite:///./users.db"


# --- üîå –°–æ–∑–¥–∞–Ω–∏–µ –¥–≤–∏–∂–∫–∞ (engine) ---
"""
–î–≤–∏–∂–æ–∫ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - connect_args: –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Ç–æ–∫–∞ –¥–ª—è SQLite
    - future=True: –≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º SQLAlchemy 2.0 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
"""
engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False}  # –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è SQLite
)


# --- üîÑ –§–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π ---
"""
SessionLocal ‚Äî —ç—Ç–æ "—Ñ–∞–±—Ä–∏–∫–∞" —Å–µ—Å—Å–∏–π, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - autocommit=False: –æ—Ç–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç (–≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç —è–≤–Ω–æ–≥–æ commit())
    - autoflush=False: –æ—Ç–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ-–≤—ã–≥—Ä—É–∑–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î
    - bind=engine: –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –∫ –¥–≤–∏–∂–∫—É

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ FastAPI —á–µ—Ä–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:
    def get_db():
        db = SessionLocal()
        try:
            yield db
        finally:
            db.close()
"""
SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine
)


# --- üß© –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –º–æ–¥–µ–ª–µ–π ---
"""
Base ‚Äî –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö ORM-–º–æ–¥–µ–ª–µ–π.
–ù–∞—Å–ª–µ–¥—É—è –æ—Ç Base, –º–æ–¥–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö SQLAlchemy.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
    class User(Base):
        __tablename__ = "users"
        id = Column(Integer, primary_key=True)
        name = Column(String)
"""
Base = declarative_base()


# --- üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ FastAPI ---
"""
–ü—Ä–∏–º–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏ –ë–î –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:

from fastapi import Depends
from sqlalchemy.orm import Session

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/users/")
def read_users(db: Session = Depends(get_db)):
    return db.query(User).all()
"""
