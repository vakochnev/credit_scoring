#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ PythonAnywhere
# 
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   export PYTHONANYWHERE_USER="your_username"
#   export PYTHONANYWHERE_HOST="ssh.pythonanywhere.com"
#   export PYTHONANYWHERE_PATH="~/credit_scoring"
#   ./scripts/deploy_pythonanywhere.sh
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   - –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π SSH –¥–æ—Å—Ç—É–ø –∫ PythonAnywhere
#   - Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
#   - –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ venv –≤ –ø—Ä–æ–µ–∫—Ç–µ

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
GREEN='\033[0;32m'  # –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
YELLOW='\033[1;33m'  # –ñ–µ–ª—Ç—ã–π –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
RED='\033[0;31m'  # –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—à–∏–±–æ–∫
NC='\033[0m'  # No Color - —Å–±—Ä–æ—Å —Ü–≤–µ—Ç–∞

echo -e "${GREEN}üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ PythonAnywhere${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$PYTHONANYWHERE_USER" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: PYTHONANYWHERE_USER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é: export PYTHONANYWHERE_USER=\"your_username\""
    exit 1
fi

if [ -z "$PYTHONANYWHERE_HOST" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: PYTHONANYWHERE_HOST –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é: export PYTHONANYWHERE_HOST=\"ssh.pythonanywhere.com\""
    exit 1
fi

if [ -z "$PYTHONANYWHERE_PATH" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: PYTHONANYWHERE_PATH –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é: export PYTHONANYWHERE_PATH=\"~/credit_scoring\""
    exit 1
fi

# –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ PythonAnywhere (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ SSH –∫–æ–º–∞–Ω–¥–∞—Ö)
PROJECT_PATH="$PYTHONANYWHERE_PATH"

# –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
echo -e "${YELLOW}üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...${NC}"
ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} << EOF
cd ${PROJECT_PATH}
git fetch origin  # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git reset --hard origin/main  # –°–±—Ä–æ—Å –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é main –≤–µ—Ç–∫–∏ (–∂–µ—Å—Ç–∫–∏–π —Å–±—Ä–æ—Å)
echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω"
EOF

# –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "${YELLOW}üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} << EOF
cd ${PROJECT_PATH}
source venv/bin/activate  # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
pip install --upgrade pip  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
pip install -r requirements.txt  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
EOF

# –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Alembic
echo -e "${YELLOW}üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} << EOF
cd ${PROJECT_PATH}
source venv/bin/activate
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
# || echo –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
alembic upgrade head || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–∂–∏–¥–∞–µ–º–æ–π)"
EOF

# –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ
echo -e "${YELLOW}üë§ –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...${NC}"
ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} << EOF
cd ${PROJECT_PATH}
source venv/bin/activate
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (admin, analyst, user)
# || echo –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
python scripts/create_users.py || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–∂–∏–¥–∞–µ–º–æ–π)"
EOF

# –®–∞–≥ 5: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ PythonAnywhere
echo -e "${YELLOW}üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...${NC}"
# PythonAnywhere –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ WSGI —Ñ–∞–π–ª–∞
# touch –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É
ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} << EOF
touch /var/www/${PYTHONANYWHERE_USER}_pythonanywhere_com_wsgi.py
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–æ"
EOF

# –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –¥–µ–ø–ª–æ—è (–∏–º–ø–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
echo -e "${YELLOW}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è...${NC}"
# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫
ssh ${PYTHONANYWHERE_USER}@${PYTHONANYWHERE_HOST} << EOF
cd ${PROJECT_PATH}
source venv/bin/activate
# –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–æ–¥—É–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
python -c "import app.main; print('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ')" || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
EOF

echo -e "${GREEN}‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"
echo -e "${GREEN}üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: https://${PYTHONANYWHERE_USER}.pythonanywhere.com${NC}"

